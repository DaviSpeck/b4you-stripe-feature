# Revisão geral e validação pré-execução — Stripe como adquirente internacional

## Pontos validados
- **Governança centralizada no backoffice**: a documentação deixa claro que o backoffice é a camada oficial de governança e que checkout/dashboard apenas consomem a decisão, reduzindo risco de decisões concorrentes sobre habilitar/bloquear Stripe.【F:docs/13-governanca-e-separacao-de-responsabilidades.md†L1-L33】【F:docs/11-detalhamento-backoffice-api.md†L1-L27】
- **Separação explícita de responsabilidades**: papéis entre backoffice, dashboard, checkout e lambdas estão descritos com limites explícitos (ex.: backoffice não executa operações financeiras; lambdas processam webhooks), o que reduz sobreposição de atribuições.【F:docs/13-governanca-e-separacao-de-responsabilidades.md†L11-L52】【F:docs/11-detalhamento-backoffice-api.md†L1-L20】【F:docs/08-detalhamento-lambdas.md†L1-L23】
- **Fonte única de estado para transações internacionais**: o estado é atualizado exclusivamente pelos webhooks nas lambdas, e as APIs/checkout/dashboard apenas exibem o estado interno, evitando polling e múltiplos “donos” de decisão de status.【F:docs/05-detalhamento-api-checkout.md†L17-L30】【F:docs/06-detalhamento-sixbase-api.md†L12-L31】【F:docs/08-detalhamento-lambdas.md†L1-L23】
- **Rastreabilidade mínima definida**: há contrato de IDs internos (`transaction_id`, `order_id`, `sale_id`) e IDs de provedor (`provider_*`), além de exigência de `provider` persistido, o que favorece auditoria e suporte fim-a-fim.【F:docs/10-contratos-e-fluxos-internos.md†L1-L27】【F:docs/03-criterios-de-aceite-e-validacao.md†L1-L46】
- **Critérios de aceite alinhados ao MVP**: critérios por projeto, regras de go/no-go e definição do MVP pronto estão documentados, ajudando a reduzir decisões pendentes durante execução.【F:docs/03-criterios-de-aceite-e-validacao.md†L1-L64】【F:docs/03-criterios-de-aceite-e-validacao.md†L66-L89】

## Pontos de atenção
- **Convergência operacional ainda não está explicitada** para saldo, saque, reembolsos e disputes entre Pagar.me e Stripe. O plano descreve separação de dados no dashboard (filtros obrigatórios e listagens separadas), mas não explicita como garantir uma “linha única de acompanhamento” exigida para operação e suporte quando aplicável.【F:docs/09-detalhamento-dashboard.md†L15-L26】【F:docs/06-detalhamento-sixbase-api.md†L6-L27】
- **Mapeamento de estados entre provedores não está documentado**: existe um conjunto de estados internos válidos, mas não há a equivalência explícita com estados do Pagar.me, o que pode gerar inconsistência de terminologia e leitura entre nacional e internacional.【F:docs/10-contratos-e-fluxos-internos.md†L31-L46】【F:docs/04-riscos-e-pontos-de-atencao.md†L3-L12】
- **Regras de reconciliação para eventos fora de ordem são citadas, mas não detalhadas**. Sem critérios explícitos, há risco de decisões ambíguas em cenários de disputa/reembolso recebidos em ordem não ideal.【F:docs/08-detalhamento-lambdas.md†L17-L27】
- **Fallback do checkout legado para fluxo nacional** quando há falha no handoff internacional pode conflitar com a marcação explícita de produto internacional e com a governança de feature flag, criando risco de estados duplos ou cobrança indevida se não houver regra clara de bloqueio operacional nesses casos.【F:docs/07-detalhamento-checkout.md†L33-L41】【F:docs/11-detalhamento-backoffice-api.md†L111-L132】
- **Feature flag e cache**: a documentação cita cache com TTL curto e prevalência do último estado, mas não define comportamento operacional quando o cache fica desatualizado, o que pode permitir criação indevida de pagamentos internacionais ou bloqueio indevido no checkout/api-checkout.【F:docs/11-detalhamento-backoffice-api.md†L105-L124】
- **Observabilidade mínima está descrita, porém sem detalhamento operacional** de como suportes e auditoria irão correlacionar eventos críticos em cenários de falha (ex.: webhooks inválidos/rejeitados). O risco é suporte depender de conhecimento profundo do Stripe, o que é apontado como risco operacional geral.【F:docs/08-detalhamento-lambdas.md†L33-L41】【F:docs/04-riscos-e-pontos-de-atencao.md†L12-L23】

## Riscos residuais
- **Fragmentação operacional**: a separação visual e por filtros entre nacional e internacional pode resultar em duas rotinas operacionais distintas, em desacordo com a necessidade de linha única de acompanhamento, caso não haja alinhamento de processos internos e terminologia consolidada.【F:docs/09-detalhamento-dashboard.md†L15-L26】【F:docs/04-riscos-e-pontos-de-atencao.md†L12-L23】
- **Estado incorreto em eventos fora de ordem**: o risco já é reconhecido, mas sem definição de política de reconciliação há possibilidade de regressão de status e inconsistência de histórico ao receber eventos atrasados ou duplicados.【F:docs/08-detalhamento-lambdas.md†L17-L27】【F:docs/04-riscos-e-pontos-de-atencao.md†L3-L12】
- **Liberação parcial por inconsistência de feature flag**: TTL/caching sem estratégia explícita de invalidação pode expor Stripe indevidamente em uma camada e bloquear em outra, gerando conflito de experiência entre checkout, api-checkout e dashboard.【F:docs/11-detalhamento-backoffice-api.md†L105-L124】【F:docs/04-riscos-e-pontos-de-atencao.md†L7-L13】
- **Suporte e auditoria sem padronização de leitura**: apesar de IDs estarem definidos, não há orientação sobre como o suporte deve interpretar status e substatus entre provedores, o que pode dificultar atendimento sem conhecimento profundo do Stripe.【F:docs/10-contratos-e-fluxos-internos.md†L1-L27】【F:docs/04-riscos-e-pontos-de-atencao.md†L12-L23】

## Recomendações finais (ajustes não estruturais)
- **Explicitar a convergência operacional** no material de governança/aceite: documentar claramente como saldo, reembolso, chargeback/dispute e histórico devem ser acompanhados de forma unificada quando possível, mantendo a separação técnica já definida.【F:docs/13-governanca-e-separacao-de-responsabilidades.md†L1-L33】【F:docs/03-criterios-de-aceite-e-validacao.md†L46-L64】
- **Formalizar a equivalência de estados** (Pagar.me ↔ modelo interno ↔ Stripe) para evitar divergência de terminologia entre nacional e internacional e reduzir interpretações ambíguas no dashboard e no suporte.【F:docs/10-contratos-e-fluxos-internos.md†L31-L46】【F:docs/06-detalhamento-sixbase-api.md†L12-L31】
- **Detalhar a política de reconciliação de eventos fora de ordem** (sem mudar arquitetura) para garantir que estados finais não sofram regressão e que disputas/reembolsos reflitam o estado correto.【F:docs/08-detalhamento-lambdas.md†L17-L27】
- **Definir o comportamento operacional do fallback do checkout** para evitar conversão silenciosa de internacional para nacional quando a governança determina uso exclusivo do Stripe para produtos internacionais.【F:docs/07-detalhamento-checkout.md†L33-L41】【F:docs/11-detalhamento-backoffice-api.md†L60-L76】
- **Reforçar diretrizes de suporte/auditoria** com base nos IDs internos e `provider_*` para mitigar dependência de conhecimento profundo do provedor durante incidentes.【F:docs/10-contratos-e-fluxos-internos.md†L1-L27】【F:docs/04-riscos-e-pontos-de-atencao.md†L12-L23】

## Parecer final
**NÃO PRONTO PARA EXECUÇÃO**. Apesar de a separação de responsabilidades e governança estarem bem definidas, faltam explicitações críticas para garantir a convergência operacional e evitar fragmentação entre nacional e internacional. As lacunas de mapeamento de estados, reconciliação de eventos fora de ordem e governança do fallback do checkout geram decisões pendentes que impactam suporte, auditoria e consistência operacional.【F:docs/13-governanca-e-separacao-de-responsabilidades.md†L1-L33】【F:docs/08-detalhamento-lambdas.md†L17-L27】【F:docs/07-detalhamento-checkout.md†L33-L41】
